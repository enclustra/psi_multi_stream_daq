<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Driver Documentation: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Driver Documentation
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Driver Documentation Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="ip_functionality"></a>
IP Core Functionality</h1>
<p>The functionality of the IP-Core is not covered in detail here, however for using the driver it may beneficial to understand what the IP-Core does. To get this information, refer to the <a href="../../psi_multi_stream_daq.pdf"><b>IP-Core documentation</b></a></p>
<h1><a class="anchor" id="thread_safety"></a>
Thread Safety</h1>
<p>The driver is not thread-safe in general. If API functions are used in more than one thread (e.g. in main and IRQs), these API functions must be protected (e.g. by disabling IRQs while the function is executing).</p>
<p>In the simplest case, the IP core is configured before IRQs are enabled and afterwards data is only read from IRQs. In this case, no protection is required.</p>
<p>Why is the IRQ disabling not implemented in the driver itself? Well, what IRQs must be disabled depends on what IRQs the driver API is used from. There may also other protection schemes be used (e.g. mutexes of a RTOS). As a result there is not single true protection mechanism that can be implemented within the driver.</p>
<h1><a class="anchor" id="irq_handling"></a>
IRQ Handling</h1>
<p>The driver supports two ways of handling IRQs. One of them (<em>Window based IRQ</em>) is a bit more elaborate and easy to use but it only covers the case, that each recorded window is processed by software. This is true in general but the IP-core also allows special configurations where data can be overwritten even if it was not processed. Since the handling of IRQs becomes more specific in this case, a special IRQ handling scheme called <em>Stream based IRQ </em> is implemented. In this case the user is responsible for implementing all actions to be taken in IRQs.</p>
<p>In all IRQ handling schemes, the user is responsible for calling the function <a class="el" href="psi__ms__daq_8h.html#a3d229aff67ff1dea2e44361a46af7a05">PsiMsDaq_HandleIrq()</a> whenever the IP core asserts its interrupt (level sensitive, high active).</p>
<p>Only one IRQ handlig scheme can be used per stream (not both at the same time for the same stream).</p>
<h2><a class="anchor" id="window_irq"></a>
Window based IRQ</h2>
<p>In this handling scheme, the driver ensures that the user callback gets called exactly once for every window that is recorded. Spurious interrupts (IRQs getting detected after the data was already processed) are suppressed by the driver. All information about the window which was completed is automatically passed to the user callback.</p>
<p>This handling scheme only works if each window is really processed by the user and protected against being overwritten until the user acknowledged the processing. Implementationwise this means that window overwriting must be disable (config.overwrite = false) and that the user must acknowledge the processing of each window before new data can be recorded into it (by calling <a class="el" href="psi__ms__daq_8h.html#a778bc5910813d6f83f11e989b0dbda44" title="Mark a window as free so it can receive new data. This function must be called after the window data ...">PsiMsDaq_StrWin_MarkAsFree()</a>).</p>
<p>Benefits of this scheme is simplicity, drawback is that the driver assumes that the user processes each window which may not be the case in special cases.</p>
<h2><a class="anchor" id="stream_irq"></a>
Stream based IRQ</h2>
<p>In this handling scheme, the driver does only detect which stream fired an IRQ and calls the user callback function. The callback function is called regardless of how many new windows were recorded. The user can do whatever processing of the IRQ he wants. This allows fine grained control over the IP core in special cases but it also means that the user is fully on his own. Therefore this option should only be used if there are good reasons for not using Window based IRQ.</p>
<h1><a class="anchor" id="example_code"></a>
Example Code</h1>
<p>This section contains a little code example to show how the driver is used.</p>
<div class="fragment"><div class="line"><span class="comment">// *** Static Variables ***</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="psi__ms__daq_8h.html#a632b59239cc6ea2aa92099ff4037d010">PsiMsDaq_IpHandle</a> daqHandle;</div><div class="line"><span class="keyword">static</span> <a class="code" href="psi__ms__daq_8h.html#aac649aaebe506c459227cd4fc66f164d">PsiMsDaq_StrHandle</a> daqStrHandle;</div><div class="line"></div><div class="line"><span class="comment">// *** System ISR ***</span></div><div class="line"><span class="comment">//ISR that is called by the OS/baremetal drivers if an IRQ is asserted</span></div><div class="line"><span class="keywordtype">void</span> PsiMsDaqIrqHandler(<span class="keywordtype">void</span>* arg)</div><div class="line">{</div><div class="line">   <span class="comment">//We assume the handle to the psi_ms_daq driver is passed as callback argument</span></div><div class="line">   <a class="code" href="psi__ms__daq_8h.html#a632b59239cc6ea2aa92099ff4037d010">PsiMsDaq_IpHandle</a> ipHandle = (<a class="code" href="psi__ms__daq_8h.html#a632b59239cc6ea2aa92099ff4037d010">PsiMsDaq_IpHandle</a>) arg;</div><div class="line">   <span class="comment">//Call IP-handling function</span></div><div class="line">   <a class="code" href="psi__ms__daq_8h.html#a3d229aff67ff1dea2e44361a46af7a05">PsiMsDaq_HandleIrq</a>(ipHandle);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// *** IP User ISR ***</span></div><div class="line"><span class="keywordtype">void</span> UserDaqIsr(<a class="code" href="struct_psi_ms_daq___win_info__t.html">PsiMsDaq_WinInfo_t</a> winInfo, <span class="keywordtype">void</span>* arg)</div><div class="line">{</div><div class="line">   <span class="comment">//Invalidate cache, example code is for xilinx devices</span></div><div class="line">   Xil_DCacheInvalidateRange(&lt;recodingLocation&gt;, &lt;recordingSize&gt;);   </div><div class="line">   <span class="comment">//Get recorded data</span></div><div class="line">   <a class="code" href="psi__ms__daq_8h.html#a8adb30f692114bde942001d1a4165b8d">PsiMsDaq_StrWin_GetDataUnwrapped</a>(winInfo, &lt;preTriggerSize&gt;, &lt;postTriggerSize&gt;, &lt;targetBuffer&gt;, <span class="keyword">sizeof</span>(&lt;targetBuffer&gt;));</div><div class="line">   <span class="comment">//Acknowledge processing of the data</span></div><div class="line">   <a class="code" href="psi__ms__daq_8h.html#a778bc5910813d6f83f11e989b0dbda44">PsiMsDaq_StrWin_MarkAsFree</a>(winInfo);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// *** Main function containing intialization ***</span></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">   <span class="comment">//Initialize IP</span></div><div class="line">   daqHandle = <a class="code" href="psi__ms__daq_8h.html#ae733dfc1b4ce6cbf490e0dd3a1ca0916">PsiMsDaq_Init</a>(&lt;baseAddress&gt;, &lt;streams&gt;, &lt;maxWindows&gt;, NULL);</div><div class="line">   <a class="code" href="psi__ms__daq_8h.html#af44ef91deb8c404f2f7983ba132b0b56">PsiMsDaq_GetStrHandle</a>(daqHandle, 0, &amp;daqStrHandle);</div><div class="line">   </div><div class="line">   <span class="comment">//Configure Stream</span></div><div class="line">   <a class="code" href="struct_psi_ms_daq___str_config__t.html">PsiMsDaq_StrConfig_t</a> cfg = {</div><div class="line">      .<a class="code" href="struct_psi_ms_daq___str_config__t.html#aff81e308f3efefb754695ce78f8cb04a">postTrigSamples</a> = &lt;postTriggerSamplesToRecord&gt;,              </div><div class="line">      .recMode = &lt;mode&gt;,</div><div class="line">      .winAsRingbuf = <span class="keyword">true</span>,</div><div class="line">      .winOverwrite = <span class="keyword">false</span>,</div><div class="line">      .winCnt = &lt;numberOfWindowsForThisStream&gt;,</div><div class="line">      .bufStartAddr = &lt;recodingLocation&gt;,</div><div class="line">      .winSize = &lt;sizePerWindow&gt;, <span class="comment">//in bytes</span></div><div class="line">      .streamWidthBits = &lt;widthInBits&gt;</div><div class="line">  };</div><div class="line">  <a class="code" href="psi__ms__daq_8h.html#aa97911b6885c81d3892846531e1e5bff">PsiMsDaq_Str_Configure</a>(daqStrHandle, &amp;cfg);</div><div class="line">  <span class="comment">//Register ballback</span></div><div class="line">  <a class="code" href="psi__ms__daq_8h.html#a41cb676a04e3d2a6b0ddf485d4ccca30">PsiMsDaq_Str_SetIrqCallbackWin</a>(daqStrHandle, UserDaqIsr, NULL);</div><div class="line">  <span class="comment">//Enable IRQ</span></div><div class="line">  <a class="code" href="psi__ms__daq_8h.html#a15d26c340105010dafd689218c3d2f8e">PsiMsDaq_Str_SetIrqEnable</a>(daqStrHandle, <span class="keyword">true</span>);</div><div class="line">  <span class="comment">//Enable recorder for stream</span></div><div class="line">  <a class="code" href="psi__ms__daq_8h.html#a0041b9e95f7758298960632b3493e2b5">PsiMsDaq_Str_SetEnable</a>(daqStrHandle, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">  <span class="comment">//Wait in endless loop for IRQs comming in</span></div><div class="line">  <span class="keywordflow">while</span>(1){};</div><div class="line">} </div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
